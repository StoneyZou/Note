## Environment Mapping(环境映射)
- 前言：环境映射是一种发生在光滑物体表面上的效果，物体周围环境反射的光经过物体表面的镜面反射直接进入到眼睛中，形成一种在物体表面上可以看到周围环境的一种效果。

- 原理：根据某个物体表面上的某个点的**入射光r的方向**，我们可以**建立r与环境(贴图)的映射关系**。

- 入射光r的计算公式:（v为从物体到眼睛视线方向，n为物体表面法线） 
$\vec{r}=2(\vec{n} \cdot \vec{v})\vec{n}-\vec{v}$


### Blinn and Newell's Method
- 原理:把周围环境映射到一个以世界坐标原点为球心的球体表面上，根据极坐标的表示方式把球体表面展开成一张长方形的环境贴图(类似世界地图展开一样)，根据入射光r的方向计算映射到球体上的哪一点，并换算为极坐标位置采样环境贴图。
- 公式：(r为入射光方向)
$$
    u=\rho=arccos(-r_{z})
 $$
 $$   
    v=\phi=atan(r_{y}, r_{c}) 
$$
- 缺点：
    1. 计算公式复杂，有两次的反三角函数运算。
    2. 环境贴图像素分布不均匀，从公式上可以看到，在$u$相等的一列上，代表的是球体上y轴两端的一条连线，而所有列并排在一起组成了球体的表面。球体的表面两端面积小，中间面积大，但是在环境贴图上两端以及中间分配的像素数量是一致的。这就导致了环境贴图像素分布不均匀。
    3. 贴图左右侧会有明显的接缝(暂时没有搞懂为什么，个人认为这个问题应该美术上可以克服)
    4. 不能动态生成环境贴图
- 优点:
    1. view-independent

### Sphere Mapping
- 原理：在相机坐标系原点，xoy平面上做一个圆，视线v垂直于圆上。以相机的y轴、x轴以及z轴的反方向作为映射空间m，把入射光r的方向转换到映射空间中为人r'，计算r'与视线v中间的法线n(half vector)在圆上的投影，投影位置则为采样像素点的位置。
- 示意图：
    ![Figure 1](http://img2.ph.126.net/U2BHYPjXiT-aD5ETNt4c4Q==/6632353094791756595.png)
- 公式：
    - v = 视线方向
    - n = 物体表面法线
    - n' = r'与映射空间的z轴(0,0,1)的half vector(不等于n在映射空间上的方向，原因的映射空间的z轴与计算r时使用的视线方向不是映射关系)
    - r = 入射光方向
    - r' = 转换到相机空间的入射光方向
    - f = 相机x轴
    - h = 相机y轴
$$
    A=
    \begin{bmatrix}
        f_x&f_y&f_z&1\\
        h_x&h_y&h_z&1\\
        v_x&v_y&v_z&1\\
        1&1&1&1
    \end{bmatrix}    
$$ 
$$  
    \vec{r}=2(\vec{n}\cdot\vec{v})\vec{n} - \vec{v}
$$ 
$$
    \vec{r'}=\vec{r}\cdot A
$$
$$
    m = |\vec{r'}+z|
$$
$$
    n'=normalize(r'+v)=normalize(r_x, r_y,r_z+1,1)
$$